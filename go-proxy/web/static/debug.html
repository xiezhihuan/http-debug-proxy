<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>HTTPè°ƒè¯•ä»£ç†æœåŠ¡ - ç®€åŒ–ç•Œé¢</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background-color: #f5f5f5; 
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
        }
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .status {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            margin-left: 10px;
        }
        .status.connected { background: #d4edda; color: #155724; }
        .status.disconnected { background: #f8d7da; color: #721c24; }
        
        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .logs-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .logs-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #dee2e6;
            font-weight: bold;
        }
        
        .log-item {
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .log-item:hover {
            background-color: #f8f9fa;
        }
        
        .log-item.selected {
            background-color: #e3f2fd;
        }
        
        .log-summary {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .method {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }
        
        .method.get { background: #28a745; }
        .method.post { background: #007bff; }
        .method.put { background: #ffc107; color: #212529; }
        .method.delete { background: #dc3545; }
        
        .status-code {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }
        
        .status-code.success { background: #28a745; }
        .status-code.error { background: #dc3545; }
        .status-code.client-error { background: #fd7e14; }
        .status-code.server-error { background: #6f42c1; }
        
        .log-url {
            flex: 1;
            font-family: monospace;
            font-size: 14px;
            color: #495057;
        }
        
        .log-time {
            color: #6c757d;
            font-size: 12px;
        }
        
        .log-duration {
            color: #6c757d;
            font-size: 12px;
        }
        
        .detail-panel {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-top: 20px;
            display: none;
        }
        
        .detail-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .detail-content {
            padding: 20px;
        }
        
        .detail-section {
            margin-bottom: 30px;
        }
        
        .detail-section h3 {
            margin-top: 0;
            color: #495057;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
        }
        
        .json-content {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .json-item {
            margin: 2px 0;
        }
        
        .json-key {
            color: #0066cc;
            font-weight: bold;
        }
        
        .json-string {
            color: #008800;
        }
        
        .json-number {
            color: #cc6600;
        }
        
        .json-boolean {
            color: #cc0066;
        }
        
        .json-null {
            color: #999999;
        }
        
        .json-toggle {
            cursor: pointer;
            user-select: none;
            display: inline-block;
            width: 16px;
            height: 16px;
            text-align: center;
            line-height: 16px;
            margin-right: 4px;
            border-radius: 2px;
            background: #e9ecef;
            color: #495057;
            font-size: 10px;
            font-weight: bold;
        }
        
        .json-toggle:hover {
            background: #007bff;
            color: white;
        }
        
        .json-collapsed {
            color: #6c757d;
            font-style: italic;
        }
        
        .json-indent {
            margin-left: 20px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }
        
        .btn-primary { background: #007bff; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        
        .btn:hover { opacity: 0.8; }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }
        
        .empty-state i {
            font-size: 48px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ HTTPè°ƒè¯•ä»£ç†æœåŠ¡</h1>
            <div>
                <span>çŠ¶æ€: </span>
                <span id="connection-status" class="status disconnected">æœªè¿æ¥</span>
                <span id="log-count">(0 æ¡è®°å½•)</span>
            </div>
        </div>
        
        <div class="controls">
            <button class="btn btn-primary" onclick="loadLogs()">åˆ·æ–°æ—¥å¿—</button>
            <button class="btn btn-danger" onclick="clearLogs()">æ¸…é™¤æ—¥å¿—</button>
            <button class="btn btn-secondary" onclick="toggleWebSocket()">åˆ‡æ¢WebSocket</button>
        </div>
        
        <div class="logs-container">
            <div class="logs-header">
                HTTPè¯·æ±‚æ—¥å¿—
            </div>
            <div id="logs-list">
                <div class="empty-state">
                    <div>ğŸ“‹</div>
                    <h3>æš‚æ— HTTPè¯·æ±‚è®°å½•</h3>
                    <p>ç­‰å¾…Androidåº”ç”¨å‘é€è¯·æ±‚...</p>
                </div>
            </div>
        </div>
        
        <div id="detail-panel" class="detail-panel">
            <div class="detail-header">
                <h3>è¯·æ±‚è¯¦æƒ…</h3>
                <button class="btn btn-secondary" onclick="copyToClipboard()">å¤åˆ¶è¯¦æƒ…</button>
            </div>
            <div class="detail-content" id="detail-content">
                <!-- è¯¦æƒ…å†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
        </div>
    </div>

    <script>
        let logs = [];
        let selectedLog = null;
        let ws = null;
        let wsEnabled = true;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadLogs();
            connectWebSocket();
        });

        // åŠ è½½æ—¥å¿—
        async function loadLogs() {
            try {
                const response = await fetch('/api/logs');
                logs = await response.json();
                updateLogsDisplay();
                updateConnectionStatus(true);
            } catch (error) {
                console.error('åŠ è½½æ—¥å¿—å¤±è´¥:', error);
                updateConnectionStatus(false);
            }
        }

        // æ¸…é™¤æ—¥å¿—
        async function clearLogs() {
            if (!confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ—¥å¿—å—ï¼Ÿ')) return;
            
            try {
                await fetch('/api/logs/clear', { method: 'POST' });
                logs = [];
                updateLogsDisplay();
                hideDetailPanel();
            } catch (error) {
                console.error('æ¸…é™¤æ—¥å¿—å¤±è´¥:', error);
            }
        }

        // æ›´æ–°æ—¥å¿—æ˜¾ç¤º
        function updateLogsDisplay() {
            const container = document.getElementById('logs-list');
            const countElement = document.getElementById('log-count');
            
            countElement.textContent = `(${logs.length} æ¡è®°å½•)`;
            
            if (logs.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div>ğŸ“‹</div>
                        <h3>æš‚æ— HTTPè¯·æ±‚è®°å½•</h3>
                        <p>ç­‰å¾…Androidåº”ç”¨å‘é€è¯·æ±‚...</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = logs.reverse().map((log, index) => `
                <div class="log-item ${selectedLog && selectedLog.id === log.id ? 'selected' : ''}" 
                     onclick="selectLog('${log.id}')">
                    <div class="log-summary">
                        <span class="method ${log.method.toLowerCase()}">${log.method}</span>
                        <span class="status-code ${getStatusClass(log.status_code)}">${log.status_code}</span>
                        <div class="log-url">${log.url}</div>
                        <div class="log-time">${formatTime(log.timestamp)}</div>
                        <div class="log-duration">${log.duration}ms</div>
                    </div>
                </div>
            `).join('');
        }

        // é€‰æ‹©æ—¥å¿—
        function selectLog(logId) {
            selectedLog = logs.find(log => log.id === logId);
            updateLogsDisplay();
            showDetailPanel();
        }

        // æ˜¾ç¤ºè¯¦æƒ…é¢æ¿
        function showDetailPanel() {
            if (!selectedLog) return;
            
            const panel = document.getElementById('detail-panel');
            const content = document.getElementById('detail-content');
            
            content.innerHTML = `
                <div class="detail-section">
                    <h3>åŸºæœ¬ä¿¡æ¯</h3>
                    <p><strong>æ–¹æ³•:</strong> ${selectedLog.method}</p>
                    <p><strong>URL:</strong> ${selectedLog.url}</p>
                    <p><strong>çŠ¶æ€ç :</strong> ${selectedLog.status_code}</p>
                    <p><strong>è€—æ—¶:</strong> ${selectedLog.duration}ms</p>
                    <p><strong>æ—¶é—´:</strong> ${formatTime(selectedLog.timestamp)}</p>
                    <p><strong>ID:</strong> ${selectedLog.id}</p>
                </div>
                
                <div class="detail-section">
                    <h3>è¯·æ±‚å¤´</h3>
                    <div class="json-content">${formatHeaders(selectedLog.request_headers)}</div>
                </div>
                
                <div class="detail-section">
                    <h3>è¯·æ±‚ä½“</h3>
                    <div class="json-content">${formatJson(selectedLog.request_body)}</div>
                </div>
                
                <div class="detail-section">
                    <h3>å“åº”å¤´</h3>
                    <div class="json-content">${formatHeaders(selectedLog.response_headers)}</div>
                </div>
                
                <div class="detail-section">
                    <h3>å“åº”ä½“</h3>
                    <div class="json-content">${formatJson(selectedLog.response_body)}</div>
                </div>
            `;
            
            panel.style.display = 'block';
        }

        // éšè—è¯¦æƒ…é¢æ¿
        function hideDetailPanel() {
            document.getElementById('detail-panel').style.display = 'none';
            selectedLog = null;
        }

        // æ ¼å¼åŒ–JSONï¼ˆæ”¯æŒæŠ˜å /å±•å¼€ï¼‰
        function formatJson(content) {
            if (!content || content.trim() === '') return '(æ— )';
            
            try {
                if (content.trim().startsWith('{') || content.trim().startsWith('[')) {
                    const parsed = JSON.parse(content);
                    return formatJsonWithToggle(parsed, 0);
                }
            } catch (e) {
                // ä¸æ˜¯æœ‰æ•ˆçš„JSONï¼Œä¿æŒåŸæ ·
            }
            
            return content;
        }

        // é€’å½’æ ¼å¼åŒ–JSONï¼Œæ”¯æŒæŠ˜å /å±•å¼€
        function formatJsonWithToggle(obj, level) {
            const indent = '  '.repeat(level);
            const nextIndent = '  '.repeat(level + 1);
            
            if (obj === null) {
                return `<span class="json-null">null</span>`;
            }
            
            if (typeof obj === 'boolean') {
                return `<span class="json-boolean">${obj}</span>`;
            }
            
            if (typeof obj === 'number') {
                return `<span class="json-number">${obj}</span>`;
            }
            
            if (typeof obj === 'string') {
                return `<span class="json-string">"${obj}"</span>`;
            }
            
            if (Array.isArray(obj)) {
                if (obj.length === 0) {
                    return '[]';
                }
                
                const itemId = 'json_' + Math.random().toString(36).substr(2, 9);
                const items = obj.map((item, index) => 
                    `<div class="json-item json-indent">${formatJsonWithToggle(item, level + 1)}</div>`
                ).join('');
                
                return `
                    <div class="json-item">
                        <span class="json-toggle" onclick="toggleJson('${itemId}')" id="toggle_${itemId}">â–¼</span>
                        <span class="json-key">[</span>
                        <span class="json-collapsed" id="collapsed_${itemId}">${obj.length} é¡¹</span>
                        <div id="expanded_${itemId}">
                            ${items}
                        </div>
                        <span class="json-key">]</span>
                    </div>
                `;
            }
            
            if (typeof obj === 'object') {
                const keys = Object.keys(obj);
                if (keys.length === 0) {
                    return '{}';
                }
                
                const itemId = 'json_' + Math.random().toString(36).substr(2, 9);
                const items = keys.map(key => 
                    `<div class="json-item json-indent">
                        <span class="json-key">"${key}":</span> ${formatJsonWithToggle(obj[key], level + 1)}
                    </div>`
                ).join('');
                
                return `
                    <div class="json-item">
                        <span class="json-toggle" onclick="toggleJson('${itemId}')" id="toggle_${itemId}">â–¼</span>
                        <span class="json-key">{</span>
                        <span class="json-collapsed" id="collapsed_${itemId}">${keys.length} ä¸ªå±æ€§</span>
                        <div id="expanded_${itemId}">
                            ${items}
                        </div>
                        <span class="json-key">}</span>
                    </div>
                `;
            }
            
            return String(obj);
        }

        // åˆ‡æ¢JSONæŠ˜å /å±•å¼€çŠ¶æ€
        function toggleJson(itemId) {
            const toggle = document.getElementById('toggle_' + itemId);
            const collapsed = document.getElementById('collapsed_' + itemId);
            const expanded = document.getElementById('expanded_' + itemId);
            
            if (expanded.style.display === 'none') {
                // å±•å¼€
                expanded.style.display = 'block';
                collapsed.style.display = 'none';
                toggle.textContent = 'â–¼';
                toggle.style.background = '#007bff';
                toggle.style.color = 'white';
            } else {
                // æŠ˜å 
                expanded.style.display = 'none';
                collapsed.style.display = 'inline';
                toggle.textContent = 'â–¶';
                toggle.style.background = '#e9ecef';
                toggle.style.color = '#495057';
            }
        }

        // æ ¼å¼åŒ–è¯·æ±‚å¤´
        function formatHeaders(headers) {
            if (!headers || Object.keys(headers).length === 0) return '(æ— )';
            
            return Object.entries(headers)
                .map(([key, values]) => `${key}: ${Array.isArray(values) ? values.join(', ') : values}`)
                .join('\n');
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString('zh-CN');
        }

        // è·å–çŠ¶æ€ç æ ·å¼ç±»
        function getStatusClass(statusCode) {
            if (statusCode >= 200 && statusCode < 300) return 'success';
            if (statusCode >= 400 && statusCode < 500) return 'client-error';
            if (statusCode >= 500) return 'server-error';
            return 'error';
        }

        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connection-status');
            statusElement.textContent = connected ? 'å·²è¿æ¥' : 'æœªè¿æ¥';
            statusElement.className = `status ${connected ? 'connected' : 'disconnected'}`;
        }

        // WebSocketè¿æ¥
        function connectWebSocket() {
            if (!wsEnabled) return;
            
            try {
                ws = new WebSocket('ws://localhost:8091/api/ws');
                
                ws.onopen = function() {
                    console.log('WebSocketè¿æ¥æˆåŠŸ');
                    updateConnectionStatus(true);
                };
                
                ws.onmessage = function(event) {
                    try {
                        const message = JSON.parse(event.data);
                        if (message.type === 'new_log') {
                            logs.push(message.data);
                            updateLogsDisplay();
                        }
                    } catch (e) {
                        console.error('è§£æWebSocketæ¶ˆæ¯å¤±è´¥:', e);
                    }
                };
                
                ws.onclose = function() {
                    console.log('WebSocketè¿æ¥å…³é—­');
                    updateConnectionStatus(false);
                    // 5ç§’åé‡è¿
                    setTimeout(connectWebSocket, 5000);
                };
                
                ws.onerror = function(error) {
                    console.error('WebSocketé”™è¯¯:', error);
                    updateConnectionStatus(false);
                };
            } catch (e) {
                console.error('WebSocketè¿æ¥å¤±è´¥:', e);
                updateConnectionStatus(false);
            }
        }

        // åˆ‡æ¢WebSocket
        function toggleWebSocket() {
            wsEnabled = !wsEnabled;
            if (wsEnabled) {
                connectWebSocket();
            } else if (ws) {
                ws.close();
                ws = null;
            }
        }

        // å¤åˆ¶åˆ°å‰ªè´´æ¿
        function copyToClipboard() {
            if (!selectedLog) return;
            
            const text = `
HTTPè¯·æ±‚è¯¦æƒ…
============
æ–¹æ³•: ${selectedLog.method}
URL: ${selectedLog.url}
çŠ¶æ€ç : ${selectedLog.status_code}
è€—æ—¶: ${selectedLog.duration}ms
æ—¶é—´: ${formatTime(selectedLog.timestamp)}
ID: ${selectedLog.id}

è¯·æ±‚å¤´:
${formatHeaders(selectedLog.request_headers)}

è¯·æ±‚ä½“:
${formatJson(selectedLog.request_body)}

å“åº”å¤´:
${formatHeaders(selectedLog.response_headers)}

å“åº”ä½“:
${formatJson(selectedLog.response_body)}
            `.trim();
            
            navigator.clipboard.writeText(text).then(function() {
                alert('è¯¦æƒ…å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            }).catch(function() {
                // é™çº§æ–¹æ¡ˆ
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('è¯¦æƒ…å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            });
        }
    </script>
</body>
</html> 